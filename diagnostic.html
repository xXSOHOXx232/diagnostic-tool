<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å§‹è¯Šæ–­ - ç”µå•†è¿è¥å¥åº·åº¦è¯Šæ–­å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .option-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .option-card:hover {
            transform: translateX(5px);
            border-color: #667eea;
            background-color: #f3f4f6;
        }
        
        .option-card.selected {
            border-color: #667eea;
            background-color: #ede9fe;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- é¡¶éƒ¨è¿›åº¦æ¡ -->
    <div class="fixed top-0 left-0 right-0 z-50 bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700">
                    ç¬¬ <span id="currentQuestionNum">1</span> é¢˜ / å…± <span id="totalQuestions">42</span> é¢˜
                </span>
                <span class="text-sm font-medium text-purple-600">
                    <span id="progressPercent">2</span>%
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progressBar" class="progress-bar gradient-bg h-2 rounded-full" style="width: 2%"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="pt-24 pb-20 px-4">
        <div class="max-w-4xl mx-auto">
            <!-- å½“å‰ç»´åº¦æ ‡ç­¾ -->
            <div id="dimensionBadge" class="inline-flex items-center px-4 py-2 rounded-full gradient-bg text-white mb-6 fade-in">
                <span id="dimensionIcon" class="text-2xl mr-2">ğŸ‘¥</span>
                <span id="dimensionName" class="font-medium">å›¢é˜Ÿèƒ½åŠ›</span>
            </div>

            <!-- é—®é¢˜å¡ç‰‡ -->
            <div id="questionCard" class="bg-white rounded-2xl shadow-lg p-8 mb-6 fade-in">
                <h2 id="questionText" class="text-2xl font-bold text-gray-900 mb-8">
                    å›¢é˜Ÿæˆå‘˜æ˜¯å¦æœ‰æ˜ç¡®çš„å²—ä½èŒè´£å’Œå·¥ä½œè¾¹ç•Œï¼Ÿ
                </h2>

                <!-- é€‰é¡¹åˆ—è¡¨ -->
                <div id="optionsList" class="space-y-4">
                    <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å¯¼èˆªæŒ‰é’® -->
            <div class="flex justify-between items-center">
                <button id="prevBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    â† ä¸Šä¸€é¢˜
                </button>
                
                <button id="nextBtn" class="px-6 py-3 gradient-bg text-white rounded-lg font-medium hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    ä¸‹ä¸€é¢˜ â†’
                </button>
                
                <button id="submitBtn" class="hidden px-8 py-3 gradient-bg text-white rounded-lg font-bold hover:opacity-90 transition">
                    æŸ¥çœ‹æŠ¥å‘Š â†’
                </button>
            </div>

            <!-- ä¾§è¾¹æ ï¼ˆæ¡Œé¢ç«¯æ˜¾ç¤ºï¼‰ -->
            <div class="hidden lg:block fixed right-8 top-32 w-64">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="font-bold text-gray-900 mb-4">è¯Šæ–­è¿›åº¦</h3>
                    <div id="dimensionProgress" class="space-y-3">
                        <!-- ç»´åº¦è¿›åº¦å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æ•°æ® -->
    <script src="js/data.js"></script>
    
    <!-- è¯Šæ–­é€»è¾‘ -->
    <script>
        class DiagnosticEngine {
            constructor() {
                this.data = diagnosticData;
                this.currentQuestionIndex = 0;
                this.answers = this.loadAnswers() || {};
                this.allQuestions = this.flattenQuestions();
                this.init();
            }

            // å°†æ‰€æœ‰é—®é¢˜å±•å¹³ä¸ºä¸€ç»´æ•°ç»„
            flattenQuestions() {
                const questions = [];
                this.data.dimensions.forEach(dimension => {
                    dimension.questions.forEach(question => {
                        questions.push({
                            ...question,
                            dimensionId: dimension.id,
                            dimensionName: dimension.name,
                            dimensionIcon: dimension.icon,
                            dimensionColor: dimension.color
                        });
                    });
                });
                return questions;
            }

            // åˆå§‹åŒ–
            init() {
                this.renderQuestion();
                this.renderDimensionProgress();
                this.updateProgress();
                this.bindEvents();
            }

            // æ¸²æŸ“å½“å‰é—®é¢˜
            renderQuestion() {
                const question = this.allQuestions[this.currentQuestionIndex];
                
                // æ›´æ–°ç»´åº¦æ ‡ç­¾
                document.getElementById('dimensionIcon').textContent = question.dimensionIcon;
                document.getElementById('dimensionName').textContent = question.dimensionName;
                
                // æ›´æ–°é—®é¢˜æ–‡æœ¬
                document.getElementById('questionText').textContent = question.question;
                
                // æ¸²æŸ“é€‰é¡¹
                const optionsList = document.getElementById('optionsList');
                optionsList.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const optionCard = document.createElement('div');
                    optionCard.className = 'option-card border-2 border-gray-200 rounded-xl p-4';
                    optionCard.dataset.score = option.score;
                    
                    // å¦‚æœå·²ç»é€‰æ‹©è¿‡ï¼Œæ·»åŠ selectedç±»
                    if (this.answers[question.id] === option.score) {
                        optionCard.classList.add('selected');
                    }
                    
                    optionCard.innerHTML = `
                        <div class="flex items-start">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full gradient-bg text-white flex items-center justify-center font-bold mr-4">
                                ${option.score}
                            </div>
                            <div class="flex-1">
                                <p class="text-gray-800">${option.text}</p>
                            </div>
                        </div>
                    `;
                    
                    optionCard.addEventListener('click', () => {
                        this.selectOption(question.id, option.score);
                    });
                    
                    optionsList.appendChild(optionCard);
                });
                
                // æ·»åŠ æ·¡å…¥åŠ¨ç”»
                document.getElementById('questionCard').classList.remove('fade-in');
                setTimeout(() => {
                    document.getElementById('questionCard').classList.add('fade-in');
                }, 10);
            }

            // é€‰æ‹©é€‰é¡¹
            selectOption(questionId, score) {
                // ä¿å­˜ç­”æ¡ˆ
                this.answers[questionId] = score;
                this.saveAnswers();
                
                // æ›´æ–°UI
                document.querySelectorAll('.option-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');
                
                // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
                document.getElementById('nextBtn').disabled = false;
                
                // æ›´æ–°è¿›åº¦
                this.updateProgress();
                this.renderDimensionProgress();
                
                // è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€é¢˜ï¼ˆå»¶è¿Ÿ500msï¼‰
                setTimeout(() => {
                    if (this.currentQuestionIndex < this.allQuestions.length - 1) {
                        this.nextQuestion();
                    }
                }, 500);
            }

            // ä¸‹ä¸€é¢˜
            nextQuestion() {
                if (this.currentQuestionIndex < this.allQuestions.length - 1) {
                    this.currentQuestionIndex++;
                    this.renderQuestion();
                    this.updateProgress();
                    this.updateButtons();
                    
                    // æ»šåŠ¨åˆ°é¡¶éƒ¨
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            // ä¸Šä¸€é¢˜
            prevQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.renderQuestion();
                    this.updateProgress();
                    this.updateButtons();
                    
                    // æ»šåŠ¨åˆ°é¡¶éƒ¨
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            // æ›´æ–°è¿›åº¦
            updateProgress() {
                const totalQuestions = this.allQuestions.length;
                const currentNum = this.currentQuestionIndex + 1;
                const answeredCount = Object.keys(this.answers).length;
                const percent = Math.round((answeredCount / totalQuestions) * 100);
                
                document.getElementById('currentQuestionNum').textContent = currentNum;
                document.getElementById('totalQuestions').textContent = totalQuestions;
                document.getElementById('progressPercent').textContent = percent;
                document.getElementById('progressBar').style.width = percent + '%';
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtons() {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                const submitBtn = document.getElementById('submitBtn');
                
                // ä¸Šä¸€é¢˜æŒ‰é’®
                prevBtn.disabled = this.currentQuestionIndex === 0;
                
                // ä¸‹ä¸€é¢˜/æäº¤æŒ‰é’®
                const currentQuestion = this.allQuestions[this.currentQuestionIndex];
                const hasAnswer = this.answers[currentQuestion.id] !== undefined;
                
                if (this.currentQuestionIndex === this.allQuestions.length - 1) {
                    // æœ€åä¸€é¢˜
                    nextBtn.classList.add('hidden');
                    submitBtn.classList.remove('hidden');
                    submitBtn.disabled = !hasAnswer;
                } else {
                    nextBtn.classList.remove('hidden');
                    submitBtn.classList.add('hidden');
                    nextBtn.disabled = !hasAnswer;
                }
            }

            // æ¸²æŸ“ç»´åº¦è¿›åº¦
            renderDimensionProgress() {
                const progressContainer = document.getElementById('dimensionProgress');
                progressContainer.innerHTML = '';
                
                this.data.dimensions.forEach(dimension => {
                    const dimensionQuestions = this.allQuestions.filter(q => q.dimensionId === dimension.id);
                    const answeredCount = dimensionQuestions.filter(q => this.answers[q.id] !== undefined).length;
                    const totalCount = dimensionQuestions.length;
                    const isComplete = answeredCount === totalCount;
                    const isCurrent = this.allQuestions[this.currentQuestionIndex].dimensionId === dimension.id;
                    
                    const progressItem = document.createElement('div');
                    progressItem.className = 'flex items-center justify-between text-sm';
                    progressItem.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-2">${dimension.icon}</span>
                            <span class="${isCurrent ? 'font-bold text-purple-600' : 'text-gray-700'}">
                                ${dimension.name}
                            </span>
                        </div>
                        <span class="${isComplete ? 'text-green-600' : 'text-gray-500'}">
                            ${isComplete ? 'âœ…' : `${answeredCount}/${totalCount}`}
                        </span>
                    `;
                    
                    progressContainer.appendChild(progressItem);
                });
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                document.getElementById('prevBtn').addEventListener('click', () => {
                    this.prevQuestion();
                });
                
                document.getElementById('nextBtn').addEventListener('click', () => {
                    this.nextQuestion();
                });
                
                document.getElementById('submitBtn').addEventListener('click', () => {
                    this.submit();
                });
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') {
                        this.prevQuestion();
                    } else if (e.key === 'ArrowRight') {
                        const currentQuestion = this.allQuestions[this.currentQuestionIndex];
                        if (this.answers[currentQuestion.id] !== undefined) {
                            this.nextQuestion();
                        }
                    } else if (e.key >= '1' && e.key <= '5') {
                        const score = parseInt(e.key);
                        const currentQuestion = this.allQuestions[this.currentQuestionIndex];
                        const option = currentQuestion.options.find(opt => opt.score === score);
                        if (option) {
                            this.selectOption(currentQuestion.id, score);
                        }
                    }
                });
            }

            // ä¿å­˜ç­”æ¡ˆåˆ°localStorage
            saveAnswers() {
                localStorage.setItem('diagnosticAnswers', JSON.stringify(this.answers));
            }

            // ä»localStorageåŠ è½½ç­”æ¡ˆ
            loadAnswers() {
                const saved = localStorage.getItem('diagnosticAnswers');
                return saved ? JSON.parse(saved) : null;
            }

            // æäº¤è¯Šæ–­
            submit() {
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é—®é¢˜éƒ½å·²å›ç­”
                const allAnswered = this.allQuestions.every(q => this.answers[q.id] !== undefined);
                
                if (!allAnswered) {
                    alert('è¯·å›ç­”æ‰€æœ‰é—®é¢˜åå†æäº¤');
                    return;
                }
                
                // è®¡ç®—ç»“æœ
                const result = this.calculateResult();
                
                // ä¿å­˜ç»“æœ
                localStorage.setItem('diagnosticResult', JSON.stringify(result));
                
                // è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢
                window.location.href = 'report.html';
            }

            // è®¡ç®—è¯Šæ–­ç»“æœ
            calculateResult() {
                const dimensionScores = [];
                
                // è®¡ç®—æ¯ä¸ªç»´åº¦çš„å¾—åˆ†
                this.data.dimensions.forEach(dimension => {
                    const dimensionQuestions = this.allQuestions.filter(q => q.dimensionId === dimension.id);
                    let totalScore = 0;
                    let totalWeight = 0;
                    
                    dimensionQuestions.forEach(question => {
                        const answer = this.answers[question.id];
                        if (answer !== undefined) {
                            totalScore += answer * question.weight;
                            totalWeight += question.weight;
                        }
                    });
                    
                    const avgScore = totalWeight > 0 ? totalScore / totalWeight : 0;
                    
                    dimensionScores.push({
                        dimension: dimension.name,
                        dimensionId: dimension.id,
                        score: Math.round(avgScore * 10) / 10,
                        maxScore: 5
                    });
                });
                
                // è®¡ç®—æ€»åˆ†ï¼ˆè½¬æ¢ä¸º100åˆ†åˆ¶ï¼‰
                const avgScore = dimensionScores.reduce((sum, d) => sum + d.score, 0) / dimensionScores.length;
                const totalScore = Math.round(avgScore * 20);
                
                // åˆ¤æ–­å¥åº·åº¦ç­‰çº§
                let level, levelStars;
                if (totalScore >= 85) {
                    level = "ä¼˜ç§€";
                    levelStars = 5;
                } else if (totalScore >= 75) {
                    level = "è‰¯å¥½";
                    levelStars = 4;
                } else if (totalScore >= 60) {
                    level = "ä¸€èˆ¬";
                    levelStars = 3;
                } else if (totalScore >= 45) {
                    level = "è¾ƒå·®";
                    levelStars = 2;
                } else {
                    level = "å¾ˆå·®";
                    levelStars = 1;
                }
                
                // è®¡ç®—è¶…è¿‡ç™¾åˆ†æ¯”
                const percentile = this.calculatePercentile(totalScore);
                
                // è¯†åˆ«é—®é¢˜
                const problems = this.identifyProblems();
                
                // ç”Ÿæˆæ”¹è¿›å»ºè®®
                const suggestions = this.generateSuggestions(dimensionScores, problems);
                
                return {
                    totalScore,
                    level,
                    levelStars,
                    percentile,
                    dimensionScores,
                    problems,
                    suggestions,
                    timestamp: new Date().toISOString()
                };
            }

            // è®¡ç®—è¶…è¿‡ç™¾åˆ†æ¯”
            calculatePercentile(totalScore) {
                const distribution = this.data.benchmark.totalScore.distribution;
                let lowerCount = 0;
                
                for (const range of distribution) {
                    const [min, max] = range.range.split('-').map(Number);
                    if (totalScore > max) {
                        lowerCount += range.percentage;
                    } else if (totalScore >= min && totalScore <= max) {
                        const rangePercentage = (totalScore - min) / (max - min) * range.percentage;
                        lowerCount += rangePercentage;
                        break;
                    }
                }
                
                return Math.round(lowerCount);
            }

            // è¯†åˆ«é—®é¢˜
            identifyProblems() {
                const problems = [];
                
                this.allQuestions.forEach(question => {
                    const answer = this.answers[question.id];
                    if (answer !== undefined && answer < 3.5) {
                        problems.push({
                            severity: answer < 2.5 ? "high" : answer < 3.5 ? "medium" : "low",
                            question: question.question,
                            score: answer,
                            suggestion: question.suggestion,
                            dimension: question.dimensionName
                        });
                    }
                });
                
                // æŒ‰ä¸¥é‡ç¨‹åº¦æ’åº
                problems.sort((a, b) => {
                    const severityOrder = { high: 0, medium: 1, low: 2 };
                    return severityOrder[a.severity] - severityOrder[b.severity];
                });
                
                return problems;
            }

            // ç”Ÿæˆæ”¹è¿›å»ºè®®
            generateSuggestions(dimensionScores, problems) {
                const suggestions = [];
                
                // æ‰¾å‡ºå¾—åˆ†æœ€ä½çš„3ä¸ªç»´åº¦
                const sortedDimensions = [...dimensionScores].sort((a, b) => a.score - b.score);
                const top3LowDimensions = sortedDimensions.slice(0, 3);
                
                top3LowDimensions.forEach((dimension, index) => {
                    // æ‰¾å‡ºè¯¥ç»´åº¦ä¸‹æœ€ä¸¥é‡çš„é—®é¢˜
                    const dimensionProblems = problems.filter(p => p.dimension === dimension.dimension);
                    
                    if (dimensionProblems.length > 0) {
                        const topProblem = dimensionProblems[0];
                        
                        suggestions.push({
                            priority: index + 1,
                            title: `ä¼˜åŒ–${dimension.dimension}`,
                            description: topProblem.suggestion,
                            expectedEffect: this.getExpectedEffect(dimension.dimensionId),
                            timeline: this.getTimeline(dimension.score)
                        });
                    }
                });
                
                return suggestions;
            }

            // è·å–é¢„æœŸæ•ˆæœ
            getExpectedEffect(dimensionId) {
                const effects = {
                    team: "å›¢é˜Ÿèƒ½åŠ›æå‡50%ï¼Œæ–°äººä¸Šæ‰‹æ—¶é—´ç¼©çŸ­70%",
                    process: "è¿è¥æ•ˆç‡æå‡40%ï¼Œå·¥ä½œè´¨é‡æå‡30%",
                    data: "æ•°æ®å‡†ç¡®ç‡æå‡50%ï¼Œå†³ç­–æ•ˆç‡æå‡60%",
                    promotion: "æ¨å¹¿ROIæå‡30%ï¼Œæ¨å¹¿æ•ˆç‡æå‡40%",
                    service: "å®¢æœè½¬åŒ–ç‡æå‡55%ï¼Œå®¢æˆ·æ»¡æ„åº¦æå‡40%",
                    content: "å†…å®¹ç‚¹å‡»ç‡æå‡50%ï¼Œè½¬åŒ–ç‡æå‡30%",
                    tools: "è¿è¥æ•ˆç‡æå‡50%ï¼ŒäººåŠ›æˆæœ¬é™ä½30%",
                    strategy: "ç›®æ ‡è¾¾æˆç‡æå‡40%ï¼Œæˆ˜ç•¥æ¸…æ™°åº¦æå‡60%"
                };
                return effects[dimensionId] || "è¿è¥æ•ˆç‡æ˜¾è‘—æå‡";
            }

            // è·å–å®æ–½å‘¨æœŸ
            getTimeline(score) {
                if (score < 2.5) return "1ä¸ªæœˆ";
                if (score < 3.5) return "2å‘¨";
                return "1å‘¨";
            }
        }

        // åˆå§‹åŒ–è¯Šæ–­å¼•æ“
        const engine = new DiagnosticEngine();
    </script>
</body>
</html>